# output usage message
$ ./index.mjs
usage: index.mjs CONFIG.mjs [USERS_JSON|USERS_JSONL]

# initialize with non-existent file
$ ./index.mjs config.mjs ./data/err-people.json
unable to read ./data/err-people.json: Error: ENOENT: no such file or directory, open './data/err-people.json'

# initialize with file containing bad data
$ ./index.mjs config.mjs ./data/err-people.jsonl
bad value "99364x" for zip
bad value "wwilli" for email address
missing value for first name

# start in background; note PID
$ ./index.mjs config.mjs ./data/people.json &
[2] 2986378
$ listening on port 1234

# page through users
# -s makes curl silent
# -k makes curl ignore locally generated cert
# json_pp pretty-prints JSON output
$ curl -s -k https://localhost:1234/users | json_pp
{
   "links" : [
      {
         "href" : "https://localhost:1234/users",
         "name" : "self",
         "rel" : "self"
      },
      {
         "href" : "https://localhost:1234/users?_offset=5",
         "name" : "next",
         "rel" : "next"
      }
   ],
   "result" : [
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/622-03-5577",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "213 Bunker Road",
            "address2" : "Apt 660",
            "city" : "Akron",
            "country" : "US",
            "email" : "crudew@binghamton.edu",
            "firstName" : "Camelia",
            "id" : "622-03-5577",
            "lastName" : "Rudewick",
            "middleInitial" : "",
            "state" : "Ohio",
            "zip" : "59886"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/100-56-0370",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "622 Lakeway Drive",
            "address2" : "",
            "city" : "Denver",
            "country" : "US",
            "email" : "xgee@binghamton.edu",
            "firstName" : "Xavier",
            "id" : "100-56-0370",
            "lastName" : "Gee",
            "middleInitial" : "C.",
            "state" : "Colorado",
            "zip" : "96061"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/845-97-2905",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "15 Penn Circle",
            "address2" : "Apt 416",
            "city" : "Jacksonville",
            "country" : "US",
            "email" : "kentin@binghamton.edu",
            "firstName" : "Kade",
            "id" : "845-97-2905",
            "lastName" : "Entinger",
            "middleInitial" : "",
            "state" : "Florida",
            "zip" : "14051"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/376-30-8922",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "797 Oilwell Road",
            "address2" : "Apt 649",
            "city" : "Corpus Christi",
            "country" : "US",
            "email" : "jfozza@binghamton.edu",
            "firstName" : "John",
            "id" : "376-30-8922",
            "lastName" : "Fozzard",
            "middleInitial" : "U.",
            "state" : "Texas",
            "zip" : "12094"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/787-82-7960",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "708 Northview Drive",
            "address2" : "Apt 566",
            "city" : "Laredo",
            "country" : "US",
            "email" : "rguill@binghamton.edu",
            "firstName" : "Rowan",
            "id" : "787-82-7960",
            "lastName" : "Guillen",
            "middleInitial" : "T.",
            "state" : "Texas",
            "zip" : "11041"
         }
      }
   ]
}

# results only for state=California
$ curl -s -k 'https://localhost:1234/users?state=California' | json_pp
{
   "links" : [
      {
         "href" : "https://localhost:1234/users?state=California",
         "name" : "self",
         "rel" : "self"
      },
      {
         "href" : "https://localhost:1234/users?state=California&_offset=5",
         "name" : "next",
         "rel" : "next"
      }
   ],
   "result" : [
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/601-24-8456",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "38 Misty Road",
            "address2" : "Apt 966",
            "city" : "San Francisco",
            "country" : "US",
            "email" : "nwesto@binghamton.edu",
            "firstName" : "Nia",
            "id" : "601-24-8456",
            "lastName" : "Westover",
            "middleInitial" : "Y.",
            "state" : "California",
            "zip" : "38184"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/257-67-4906",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "611 West Circle",
            "address2" : "",
            "city" : "Los Angeles",
            "country" : "US",
            "email" : "galtge@binghamton.edu",
            "firstName" : "Gloria",
            "id" : "257-67-4906",
            "lastName" : "Altgelt",
            "middleInitial" : "Q.",
            "state" : "California",
            "zip" : "86316"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/539-35-2112",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "958 Sheltie Loop",
            "address2" : "Apt 435",
            "city" : "Oakland",
            "country" : "US",
            "email" : "wdunn@binghamton.edu",
            "firstName" : "Wyatt",
            "id" : "539-35-2112",
            "lastName" : "Dunn",
            "middleInitial" : "X.",
            "state" : "California",
            "zip" : "24064"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/884-04-5700",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "779 Center Street",
            "address2" : "",
            "city" : "San Francisco",
            "country" : "US",
            "email" : "jwhetz@binghamton.edu",
            "firstName" : "Janay",
            "id" : "884-04-5700",
            "lastName" : "Whetzel",
            "middleInitial" : "L.",
            "state" : "California",
            "zip" : "13842"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/456-76-8890",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "967 Craig Drive",
            "address2" : "Apt 16",
            "city" : "Glendale",
            "country" : "US",
            "email" : "jwitze@binghamton.edu",
            "firstName" : "Janae",
            "id" : "456-76-8890",
            "lastName" : "Witzel",
            "middleInitial" : "O.",
            "state" : "California",
            "zip" : "95062"
         }
      }
   ]
}

# page next two results
$ curl -s -k 'https://localhost:1234/users?state=California&_offset=5&_limit=2' | json_pp
{
   "links" : [
      {
         "href" : "https://localhost:1234/users?state=California&_offset=5&_limit=2",
         "name" : "self",
         "rel" : "self"
      },
      {
         "href" : "https://localhost:1234/users?state=California&_offset=7&_limit=2",
         "name" : "next",
         "rel" : "next"
      },
      {
         "href" : "https://localhost:1234/users?state=California&_offset=3&_limit=2",
         "name" : "prev",
         "rel" : "prev"
      }
   ],
   "result" : [
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/336-83-7572",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "298 Lily Circle",
            "address2" : "",
            "city" : "Modesto",
            "country" : "US",
            "email" : "mwisni@binghamton.edu",
            "firstName" : "Mara",
            "id" : "336-83-7572",
            "lastName" : "Wisniewski",
            "middleInitial" : "V.",
            "state" : "California",
            "zip" : "41499"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/974-35-1852",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "897 Flamingo Drive",
            "address2" : "Apt 477",
            "city" : "Fremont",
            "country" : "US",
            "email" : "ewarri@binghamton.edu",
            "firstName" : "Evan",
            "id" : "974-35-1852",
            "lastName" : "Warrick",
            "middleInitial" : "D.",
            "state" : "California",
            "zip" : "12280"
         }
      }
   ]
}

# use prev link from last output
$ curl -s -k \
  'https://localhost:1234/users?state=California&_offset=3&_limit=2' | json_pp
{
   "links" : [
      {
         "href" : "https://localhost:1234/users?state=California&_offset=3&_limit=2",
         "name" : "self",
         "rel" : "self"
      },
      {
         "href" : "https://localhost:1234/users?state=California&_offset=5&_limit=2",
         "name" : "next",
         "rel" : "next"
      },
      {
         "href" : "https://localhost:1234/users?state=California&_offset=1&_limit=2",
         "name" : "prev",
         "rel" : "prev"
      }
   ],
   "result" : [
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/884-04-5700",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "779 Center Street",
            "address2" : "",
            "city" : "San Francisco",
            "country" : "US",
            "email" : "jwhetz@binghamton.edu",
            "firstName" : "Janay",
            "id" : "884-04-5700",
            "lastName" : "Whetzel",
            "middleInitial" : "L.",
            "state" : "California",
            "zip" : "13842"
         }
      },
      {
         "links" : [
            {
               "href" : "https://localhost:1234/users/456-76-8890",
               "name" : "self",
               "rel" : "self"
            }
         ],
         "result" : {
            "address1" : "967 Craig Drive",
            "address2" : "Apt 16",
            "city" : "Glendale",
            "country" : "US",
            "email" : "jwitze@binghamton.edu",
            "firstName" : "Janae",
            "id" : "456-76-8890",
            "lastName" : "Witzel",
            "middleInitial" : "O.",
            "state" : "California",
            "zip" : "95062"
         }
      }
   ]
}

# Get specific user (last user from above output)
$ curl -s -k 'https://localhost:1234/users/456-76-8890' | json_pp
{
   "links" : [
      {
         "href" : "https://localhost:1234/users/456-76-8890",
         "name" : "self",
         "rel" : "self"
      }
   ],
   "result" : {
      "address1" : "967 Craig Drive",
      "address2" : "Apt 16",
      "city" : "Glendale",
      "country" : "US",
      "email" : "jwitze@binghamton.edu",
      "firstName" : "Janae",
      "id" : "456-76-8890",
      "lastName" : "Witzel",
      "middleInitial" : "O.",
      "state" : "California",
      "zip" : "95062"
   }
}

# Update specified user.
# -X specifies HTTP method
# -d specified body
# -H specifies content-type of body
# zip fails validation
$ curl -s -X PATCH -H 'Content-Type: application/json' -k \
       -d '{"zip":"1234x"}' \
       'https://localhost:1234/users/456-76-8890' | json_pp
{
   "errors" : [
      {
         "message" : "bad value \"1234x\" for zip",
         "options" : {
            "code" : "BAD_VAL",
            "widget" : "zip"
         }
      }
   ],
   "status" : 400
}

# fix zip and retry
$ curl -s -X PATCH -H 'Content-Type: application/json' -k \
       -d '{"zip":"12345"}' \
       'https://localhost:1234/users/456-76-8890'
       
# check for update
$ curl -s -k 'https://localhost:1234/users/456-76-8890' | json_pp
{
   "links" : [
      {
         "href" : "https://localhost:1234/users/456-76-8890",
         "name" : "self",
         "rel" : "self"
      }
   ],
   "result" : {
      "address1" : "967 Craig Drive",
      "address2" : "Apt 16",
      "city" : "Glendale",
      "country" : "US",
      "email" : "jwitze@binghamton.edu",
      "firstName" : "Janae",
      "id" : "456-76-8890",
      "lastName" : "Witzel",
      "middleInitial" : "O.",
      "state" : "California",
      "zip" : "12345"
   }
}

# delete user
$ curl -s -X DELETE -k 'https://localhost:1234/users/456-76-8890' 

# user not found
$ curl -s -k 'https://localhost:1234/users/456-76-8890' | json_pp
{
   "errors" : [
      {
         "message" : "user 456-76-8890 not found",
         "options" : {
            "code" : "NOT_FOUND"
         }
      }
   ],
   "status" : 404
}


# -D /dev/stderr writes received HTTP headers to stderr
$ curl -s -D /dev/stderr -k 'https://localhost:1234/users/456-76-8890' \
     | json_pp
HTTP/1.1 404 Not Found
X-Powered-By: Express
Access-Control-Allow-Origin: *
Content-Type: application/json; charset=utf-8
Content-Length: 97
ETag: W/"61-MgvIKcBzBBJLRBwS/ZwF793yFM8"
Date: Wed, 27 Oct 2021 20:10:00 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{
   "errors" : [
      {
         "message" : "user 456-76-8890 not found",
         "options" : {
            "code" : "NOT_FOUND"
         }
      }
   ],
   "status" : 404
}

# show contents of data file
$ cat ./data/1person.json | json_pp
{
   "address1" : "138 Lower Street",
   "address2" : "Apt 597",
   "city" : "Tucson",
   "country" : "US",
   "email" : "cwilso@binghamton.edu",
   "firstName" : "Clara",
   "id" : "123-45-6789",
   "lastName" : "Wilson",
   "middleInitial" : "E.",
   "state" : "Arizona",
   "zip" : "07402"
}


# create new user from data file
$ curl -s -X POST -D /dev/stderr -H 'Content-Type: application/json' -k -d @./data/1person.json  'https://localhost:1234/users' 
HTTP/1.1 201 Created
X-Powered-By: Express
Access-Control-Allow-Origin: *
Location: https://localhost:1234/users/123-45-6789
Content-Type: text/plain; charset=utf-8
Content-Length: 7
ETag: W/"7-rM9AyJuqT6iOan/xHh+AW+7K/T8"
Date: Wed, 27 Oct 2021 20:12:39 GMT
Connection: keep-alive
Keep-Alive: timeout=5

Created

# retrieve newly created user
$ curl -s -D /dev/stderr -k 'https://localhost:1234/users/123-45-6789' \
      |  json_pp
HTTP/1.1 200 OK
X-Powered-By: Express
Access-Control-Allow-Origin: *
Content-Type: application/json; charset=utf-8
Content-Length: 327
ETag: W/"147-42AoX/I8IqpcnHkoBUccQJp61xw"
Date: Wed, 27 Oct 2021 20:13:25 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{
   "links" : [
      {
         "href" : "https://localhost:1234/users/123-45-6789",
         "name" : "self",
         "rel" : "self"
      }
   ],
   "result" : {
      "address1" : "138 Lower Street",
      "address2" : "Apt 597",
      "city" : "Tucson",
      "country" : "US",
      "email" : "cwilso@binghamton.edu",
      "firstName" : "Clara",
      "id" : "123-45-6789",
      "lastName" : "Wilson",
      "middleInitial" : "E.",
      "state" : "Arizona",
      "zip" : "07402"
   }
}

# show update file
$ cat ./data/1person-update.json | json_pp
{
   "email" : "cwilso1@binghamton.edu",
   "id" : "123-45-6789",
   "zip" : "12345"
}

# update user
$ curl -s -X PATCH -D /dev/stderr -H 'Content-Type: application/json' -k \
       -d @./data/1person-update.json \
       'https://localhost:1234/users/123-45-6789' 
HTTP/1.1 204 No Content
X-Powered-By: Express
Access-Control-Allow-Origin: *
ETag: W/"a-bAsFyilMr4Ra1hIU5PyoyFRunpI"
Date: Wed, 27 Oct 2021 20:14:34 GMT
Connection: keep-alive
Keep-Alive: timeout=5

# show updated user
$ curl -s -D /dev/stderr -k 'https://localhost:1234/users/123-45-6789' \
     | json_pp
HTTP/1.1 200 OK
X-Powered-By: Express
Access-Control-Allow-Origin: *
Content-Type: application/json; charset=utf-8
Content-Length: 328
ETag: W/"148-4gw3P+DCk7/2KPqDs/hSFaQH9n8"
Date: Wed, 27 Oct 2021 20:14:53 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{
   "links" : [
      {
         "href" : "https://localhost:1234/users/123-45-6789",
         "name" : "self",
         "rel" : "self"
      }
   ],
   "result" : {
      "address1" : "138 Lower Street",
      "address2" : "Apt 597",
      "city" : "Tucson",
      "country" : "US",
      "email" : "cwilso1@binghamton.edu",
      "firstName" : "Clara",
      "id" : "123-45-6789",
      "lastName" : "Wilson",
      "middleInitial" : "E.",
      "state" : "Arizona",
      "zip" : "12345"
   }
}


# replace user with original data
$ curl -s -X PUT -D /dev/stderr -H 'Content-Type: application/json' -k \
       -d @./data/1person.json
       'https://localhost:1234/users/123-45-6789' 
HTTP/1.1 204 No Content
X-Powered-By: Express
Access-Control-Allow-Origin: *
ETag: W/"a-bAsFyilMr4Ra1hIU5PyoyFRunpI"
Date: Wed, 27 Oct 2021 20:15:40 GMT
Connection: keep-alive
Keep-Alive: timeout=5

# show replaced user
$ curl -s -D /dev/stderr -k 'https://localhost:1234/users/123-45-6789'
      | json_pp
HTTP/1.1 200 OK
X-Powered-By: Express
Access-Control-Allow-Origin: *
Content-Type: application/json; charset=utf-8
Content-Length: 327
ETag: W/"147-42AoX/I8IqpcnHkoBUccQJp61xw"
Date: Wed, 27 Oct 2021 20:15:46 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{
   "links" : [
      {
         "href" : "https://localhost:1234/users/123-45-6789",
         "name" : "self",
         "rel" : "self"
      }
   ],
   "result" : {
      "address1" : "138 Lower Street",
      "address2" : "Apt 597",
      "city" : "Tucson",
      "country" : "US",
      "email" : "cwilso@binghamton.edu",
      "firstName" : "Clara",
      "id" : "123-45-6789",
      "lastName" : "Wilson",
      "middleInitial" : "E.",
      "state" : "Arizona",
      "zip" : "07402"
   }
}

# show pid
lsof -i :1234
COMMAND     PID    USER   FD   TYPE    DEVICE SIZE/OFF NODE NAME
node    2986378 umrigar   31u  IPv6 114763375      0t0  TCP *:1234 (LISTEN)

# kill server
$ kill 2986378
10-27T16:16:15|main/user-ws $ 
[2]+  Terminated              ./index.mjs config.mjs ./data/people.json

#restart
$ ./index.mjs config.mjs ./data/people.json &
[1] 2990642
$ listening on port 1234

# show data survives restart
$ curl -s -D /dev/stderr -k 'https://localhost:1234/users/123-45-6789' | json_pp
HTTP/1.1 200 OK
X-Powered-By: Express
Access-Control-Allow-Origin: *
Content-Type: application/json; charset=utf-8
Content-Length: 327
ETag: W/"147-42AoX/I8IqpcnHkoBUccQJp61xw"
Date: Wed, 27 Oct 2021 20:16:44 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{
   "links" : [
      {
         "href" : "https://localhost:1234/users/123-45-6789",
         "name" : "self",
         "rel" : "self"
      }
   ],
   "result" : {
      "address1" : "138 Lower Street",
      "address2" : "Apt 597",
      "city" : "Tucson",
      "country" : "US",
      "email" : "cwilso@binghamton.edu",
      "firstName" : "Clara",
      "id" : "123-45-6789",
      "lastName" : "Wilson",
      "middleInitial" : "E.",
      "state" : "Arizona",
      "zip" : "07402"
   }
}

# delete
$ curl -s -X DELETE -D /dev/stderr -k 'https://localhost:1234/users/123-45-6789' 
HTTP/1.1 204 No Content
X-Powered-By: Express
Access-Control-Allow-Origin: *
ETag: W/"a-bAsFyilMr4Ra1hIU5PyoyFRunpI"
Date: Wed, 27 Oct 2021 20:17:14 GMT
Connection: keep-alive
Keep-Alive: timeout=5

# it's gone
$ curl -s -D /dev/stderr -k 'https://localhost:1234/users/123-45-6789' \
      | json_pp
HTTP/1.1 404 Not Found
X-Powered-By: Express
Access-Control-Allow-Origin: *
Content-Type: application/json; charset=utf-8
Content-Length: 97
ETag: W/"61-EmOUFHX7qHwi6irczjBdO2Z4DsQ"
Date: Wed, 27 Oct 2021 20:17:20 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{
   "errors" : [
      {
         "message" : "user 123-45-6789 not found",
         "options" : {
            "code" : "NOT_FOUND"
         }
      }
   ],
   "status" : 404
}

$ kill 2990642
[1]+  Terminated              ./index.mjs config.mjs ./data/people.json

$ 